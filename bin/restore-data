#!/bin/bash
ami=
while [ $# -gt 0 ] ; do
  case "$1" in
    --ami)             ami="$2"; shift;;
    --)                shift; break;;
    -*)                shift;;
    *)                 break;;
  esac
  shift
done

if [ $# -gt 0 ] ; then
  s3bucket=$1
  shift
else
  echo "usage: restore-data <s3bucket>" && exit 1
fi

bin=`dirname "$0"`
bin=`cd "$bin"; pwd`
export bin
if [ -f "$bin"/credentials.sh ] ; then
  source "$bin"/credentials.sh
fi
source "$bin"/env.sh

if [ -z $ami ] ; then
  echo "Searching for AMI for $IMAGE_VERSION (may take some time if on a slow network)..."
  CMD="ec2-describe-images $TOOL_OPTS -a | grep $S3_ACCOUNT | grep $IMAGE_VERSION | grep available | awk '{print $2}'"
  echo $CMD
  AMI_IMAGE=`ec2-describe-images $TOOL_OPTS -a | grep $S3_ACCOUNT | grep $IMAGE_VERSION | grep available | awk '{print $2}'`
else
  AMI_IMAGE=$ami
fi
echo "AMI_IMAGE: $AMI_IMAGE"
[ -z $AMI_IMAGE ] && echo "No AMI found" && exit 1

MASTER=`cat /tmp/ec2-master`
[ -z $MASTER ] && echo "Hostname for Master can not be found" && exit 1
echo -n "Polling master,$MASTER, process status "
while true; do
printf "."
msg=`ssh -n $SSH_OPTS "ec2-user@$MASTER" "cat /etc/hadoop/conf/message"`
if [ $msg == success ] ; then
  echo
  echo "All processes are up in master"
  break;
fi
sleep 5
done

echo "Polling slave processes status"
ec2-describe-instances $TOOL_OPTS --filter instance-lifecycle=spot --filter image-id=$AMI_IMAGE | grep running | awk '{print $4}'>/tmp/ec2-slaves
cat /tmp/ec2-slaves | while read SLAVE
do
  echo -n "Slave : $SLAVE"
  while true; do
    printf "."
    msg=`ssh -n $SSH_OPTS "ec2-user@$SLAVE" "cat /etc/hadoop/conf/message"`
    if [ $msg == success ] ; then
      echo
      echo "All processes are up in slave $SLAVE"
      break
    fi
    sleep 5
  done
done

echo "Going to copy HBase data from S3 $s3bucket/hbase"
ssh  $SSH_OPTS "ec2-user@$MASTER" "sudo /usr/lib/hadoop/bin/hadoop distcp -conf /etc/hadoop/conf/mapred-site.xml s3://$AWS_ACCESS_KEY_ID:$AWS_SECRET_ACCESS_KEY@$s3bucket/hbase \ hdfs://$MASTER:8020/hbase "
#!/bin/bash
#script to start the master and regionserver remotely
ami=
profile=n
gc=CMS
mem='-Xmx32g -Xmn16g'
while [ $# -gt 0 ] ; do
  case "$1" in
    --ami)             ami="$2"; shift;;
    --gc)              gc="$2"; shift;;
    --mem)             mem="$2"; shift;;
    -p | --profile)    profile=y ;;
    --)                shift; break;;
    -*)                shift;;
    *)                 break;;
  esac
  shift
done

bin=`dirname "$0"`
bin=`cd "$bin"; pwd`
export bin
if [ -f "$bin"/credentials.sh ] ; then
  source "$bin"/credentials.sh
fi
source "$bin"/env.sh

if [ -z $ami ] ; then
  echo "Searching for AMI for $IMAGE_VERSION (may take some time if on a slow network)..."
  CMD="ec2-describe-images $TOOL_OPTS -a | grep $S3_ACCOUNT | grep $IMAGE_VERSION | grep available | awk '{print $2}'"
  echo $CMD
  AMI_IMAGE=`ec2-describe-images $TOOL_OPTS -a | grep $S3_ACCOUNT | grep $IMAGE_VERSION | grep available | awk '{print $2}'`
else
  AMI_IMAGE=$ami
fi
echo "AMI_IMAGE: $AMI_IMAGE"
[ -z $AMI_IMAGE ] && echo "No AMI found" && exit 1

# start the HMaster in the master node
cat /tmp/ec2-master | while read MASTER
do
 echo "Starting HBase Master at $MASTER"
 # Start ZooKeeper (but managed by HBase)
 ssh -n $SSH_OPTS "ec2-user@$MASTER" "sudo /usr/lib/hbase/bin/hbase-daemon.sh --config /etc/hbase/conf start zookeeper"
 sleep 2
 ssh -n $SSH_OPTS "ec2-user@$MASTER" "sudo /usr/lib/hbase/bin/hbase-daemon.sh --config /etc/hbase/conf start master"
done

echo "Starting RS in all slave nodes"
echo "GC algorithm: $gc with memory setting : $mem"

# start the regionserver in the slave nodes
ec2-describe-instances $TOOL_OPTS --filter instance-lifecycle=spot --filter image-id=$AMI_IMAGE | grep running | awk '{print $4}'>/tmp/ec2-slaves
cat /tmp/ec2-slaves | while read SLAVE
do
 echo "Starting HBase RS at Slave : $SLAVE"
 ssh -n $SSH_OPTS "ec2-user@$SLAVE" "sudo /etc/hbase/start-rs $gc '$mem' $profile"
done
